{
    "contents" : "library(dplyr)\nlibrary(RSQLite)\n\ndrop1 = function(tmp){\n  return(substr(tmp, start = 25, stop = nchar(tmp)))  \n}\n\ndrop2 = function(tmp){\n  return(substr(tmp, start = 21, stop = nchar(tmp)))  \n}\n\ncreateA <- function(x,y)\n{\n  ux = unique(x); uy = unique(y);\n  n  = length(x); nx = length(ux); ny = length(uy)\n  cx = match(x,ux); cy = match(y,uy);\n  A  = spMatrix(nrow = nx , ncol = ny, \n                i = cx , j = cy , x = rep(1,n))\n  \n  #up = lapply(uy,drop2)\n  up=uy\n  colnames(A) = up\n<<<<<<< HEAD\n  rownames(A) = ux\n=======\n>>>>>>> b5021e41b90ad74fbf1c3b4d4ad43ef0d4eb731a\n  return(A)\n}\n\ncreateB <- function(cc,a,ncluster)\n{\n  Y = model.matrix(~as.factor(cc)-1)\n  yy = solve(t(Y)%*%Y)\n  ap = a%*%Y%*%yy\n  apn =t(apply(ap,1,function(x) return(x/sqrt(sum(x^2)))))\n  \n  kmap = kmeans(apn, ncluster, nstart = 1000)\n  \n  Zhat = sparse.model.matrix(~as.factor(kmap$clust)-1)\n  zz = solve(t(Zhat)%*%Zhat)\n  bhat = zz%*%t(Zhat)%*%a%*%Y%*%yy\n  \n  B0=round(bhat*3239)\n  \n  return(B0)\n  \n}\n\n\ncreate_fanwords <- function(A)\n{\n  fan = A %>% rownames %>% unique\n  cfan = match(A %>% rownames,fan)\n  nx=length(fan);ny=length(A[1,])\n<<<<<<< HEAD\n  B = spMatrix(nrow = nx , ncol = ny, \n               i = cfan[A@i+1]  , j = A@j+1 , x = A@x ) \n  rownames(B) = fan\n  colnames(B) = colnames(A)\n  return(B)\n}\n  \n  \n=======\n  \n  Bi = NULL; Bj = NULL; Bx = NULL;\n  for (i in 1:nx)\n  {\n    cf = which(cfan==i); \n    \n    ci = which(A@i %in% (cf-1)); uj = A@j[ci]; ni = length(ci);\n    Bi = c(Bi,rep(i,ni)); Bj = c(Bj, uj); Bx = c(Bx,A@x[ci])\n  }\n  \n    B = spMatrix(nrow = nx , ncol = ny, \n                 i = Bi  , j = Bj+1 , x = Bx )  \n   \n  colnames(B)=colnames(A)\n  rownames(B)=fan\n  return(B)\n}\n>>>>>>> b5021e41b90ad74fbf1c3b4d4ad43ef0d4eb731a\n\ncombind_fanwords <- function(A1,A2)\n{\n  rn1 = A1 %>% rownames; rn2 = A2 %>% rownames\n  cn1 = A1 %>% colnames; cn2 = A2 %>% colnames\n  \n  fan = c(rn1, rn2) %>% unique\n  cfan1 = match(rn1,fan)\n  cfan2 = match(rn2,fan)\n  \n  words = c(cn1, cn2) %>% unique\n  cword1 = match(cn1,words)\n  cword2 = match(cn2,words)\n  \n  nx=length(fan);ny=length(words)\n  \n  Bi = NULL; Bj = NULL; Bx = NULL;\n  for (i in 1:nx)\n  {\n    cf = which(cfan1==i);     \n    ci = which(A1@i %in% (cf-1)); uj = cword1[(A1@j[ci]+1)]; ni = length(ci);\n    Bi = c(Bi,rep(i,ni)); Bj = c(Bj, uj); Bx = c(Bx,A1@x[ci])\n    \n    cf = which(cfan2==i);    \n    ci = which(A2@i %in% (cf-1)); uj = cword2[(A2@j[ci]+1)]; ni = length(ci);\n    Bi = c(Bi,rep(i,ni)); Bj = c(Bj, uj); Bx = c(Bx,A2@x[ci])\n  }\n  \n  B = spMatrix(nrow = nx , ncol = ny, \n               i = Bi  , j = Bj , x = Bx )  \n  \n  colnames(B)=words\n  rownames(B)=fan\n  return(B)\n}\n\n\n\n\nlibrary(irlba)\n\nsvdmatrix <- function(A)\n{\n  rs=rowSums(A);cs=colSums(A)\n  L = Diagonal(length(rs),1/sqrt(rs + mean(rs)))%*%\n    A%*%Diagonal(length(cs),1/sqrt(cs + mean(cs)))\n  sf=irlba(L,nu=20,nv=20)\n  return(sf)\n}\n\nsv_bydate <- function(v , datem, cc, npost, ncluster)\n{\n  id=1:npost\n  dfvd=data.frame(v,datem,cc,id)\n  dfvdo=dfvd[order(dfvd$cc,dfvd$datem),]\n  dfvdo=as.matrix(dfvdo)\n  vd=dfvdo[,1:ncluster]\n  \n  dfvdl=dfvd[order(dfvd$datem),]\n  dfvdl=as.matrix(dfvdl)\n  vdl=dfvdl[,1:ncluster]\n  \n  datem_od=dfvdl[,(ncluster+1)]\n  daten=rep(1,ndate)\n  for(i in 2:ndate){daten[i]=sum(datem_od<=(i-1))+1}\n  return(list(vd=vd,vdl=vdl,dfvdl=dfvdl,daten=daten))\n}\n\nmyStopwords <- c(stopwords(\"French\"),\n                 \"http\",\"www\",\"facebook\",\"com\",\"le\")\n\n<<<<<<< HEAD\ntextclean <- function (x)\n{\n  myCorpus <- x %>% VectorSource %>% Corpus\n  myCorpus <- myCorpus %>% tm_map(removeWords,myStopwords) %>% tm_map(removeNumbers)\n  mytdm <- myCorpus %>% TermDocumentMatrix\n  return(mytdm)\n}\n\n\nfreqmatr <- function(mytdm,rname)\n{\n  \n  freqterm <- findFreqTerms(mytdm, lowfreq = (length(mytdm$ncol)/1000), highfreq = Inf)\n=======\ntextclean <- function(x,rname)\n{\n  myCorpus <- x %>% VectorSource %>% Corpus\n  myCorpus <- myCorpus %>% tm_map(removeWords,myStopwords) %>% tm_map(removeNumbers)\n \n  mytdm <- myCorpus %>% TermDocumentMatrix\n  freqterm <- findFreqTerms(mytdm, lowfreq = (length(x)/1000), highfreq = Inf)\n>>>>>>> b5021e41b90ad74fbf1c3b4d4ad43ef0d4eb731a\n  \n  freqc <- mytdm[freqterm,]\n  freqm <- spMatrix(nrow=freqc$ncol,ncol=freqc$nrow,i=freqc$j,j=freqc$i,x=freqc$v)\n  colnames(freqm) <- freqterm\n  rownames(freqm) <- rname\n  #freqcount <- colSums(freqm)  \n  #freq <- data.frame(freqterm,freqcount)\n  #freqdf <-freq[order(freq$freqcount,decreasing=TRUE),]\n  return(freqm)\n}\n\n\n\nballoonPlot = function(M, logTran, sqrtTran, main, namesx, namesy, margin, mult){\n  # M is a matrix. want to plot each element as a dot.  \n  # dot size corresponds to magnitude.\n  # dot color black/red corresponds to sign.\n  \n  n = nrow(M)\n  d = ncol(M)\n  \n  scaleItMean = mean(abs(M))\n  \n  if(logTran){\n    scaleItMean = mean(log(abs(M) +1))\n  }\n  if(sqrtTran){\n    scaleItMean = mean(sqrt(abs(M)))\n  }\n  par(mar = c(margin,margin,2,2))\n  plot(c(.5,d+.5), c(.5,n+.5), col = \"white\", main = main, axes = F, ylab = \"\", xlab =\"\")\n  if(length(namesx) !=F)  \taxis(1, at = 1:d, labels = namesx, lty = 0, las = 2)\n  if(length(namesy) !=F)    axis(2, at = n:1, labels = namesy, lty = 0, las = 2)\n  \n  \n  for(i in 1:n){\n    for(j in 1:d){\n      dotSize = abs(M[i,j])/scaleItMean\n      if(logTran) dotSize = log(dotSize + 1)/scaleItMean\n      if(sqrtTran) dotSize = sqrt(dotSize)/scaleItMean\n      dotColor = \"black\"\n      if(M[i,j] < 0) dotColor = \"red\"\n      points(j,n+1 - i, pch = 19, cex = dotSize*mult, col = dotColor)\n      \n    }\n  }\n}\n",
    "created" : 1429839767250.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1165860818",
    "id" : "F2F69686",
    "lastKnownWriteTime" : 1429724111,
    "path" : "C:/Users/Administrator/Frenchpj/code/functions.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}